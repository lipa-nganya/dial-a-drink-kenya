# How Push Token is Generated

## Overview

The push token is **NOT generated by our code**. It's generated by:
- **Android**: Firebase Cloud Messaging (FCM) service
- **iOS**: Apple Push Notification Service (APNs)
- **Expo Go**: Expo's push notification service

Our code only **requests** the token from these services and then sends it to our backend.

## Complete Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. REQUEST PERMISSIONS                                       â”‚
â”‚    - Check if notification permissions are granted           â”‚
â”‚    - If not, request permissions from user                   â”‚
â”‚    - If denied, return null (can't get token)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. DETECT BUILD TYPE                                         â”‚
â”‚    - Check Constants.appOwnership                             â”‚
â”‚    - Check Constants.executionEnvironment                    â”‚
â”‚    - Determine: Standalone build OR Expo Go                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                     â”‚
        â†“                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STANDALONE BUILD       â”‚         â”‚ EXPO GO / DEV         â”‚
â”‚ (Production APK)       â”‚         â”‚ (Development)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                     â”‚
        â†“                                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3a. GET NATIVE TOKEN   â”‚         â”‚ 3b. GET EXPO TOKEN     â”‚
â”‚                        â”‚         â”‚                        â”‚
â”‚ Notifications.         â”‚         â”‚ Notifications.         â”‚
â”‚   getDevicePushToken   â”‚         â”‚   getExpoPushToken     â”‚
â”‚   Async()              â”‚         â”‚   Async()              â”‚
â”‚                        â”‚         â”‚                        â”‚
â”‚ This calls:            â”‚         â”‚ This calls:            â”‚
â”‚ - Android: FCM SDK     â”‚         â”‚ - Expo Push Service    â”‚
â”‚ - iOS: APNs SDK        â”‚         â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                     â”‚
        â”‚                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. TOKEN GENERATED BY SERVICE                                â”‚
â”‚                                                              â”‚
â”‚ For Standalone (Android):                                    â”‚
â”‚   - FCM SDK contacts Google's FCM servers                    â”‚
â”‚   - Google generates unique FCM token for this device        â”‚
â”‚   - Token format: Long alphanumeric string                   â”‚
â”‚     Example: "fcm1234567890abcdef..."                        â”‚
â”‚                                                              â”‚
â”‚ For Standalone (iOS):                                        â”‚
â”‚   - APNs SDK contacts Apple's APNs servers                   â”‚
â”‚   - Apple generates unique APNs token for this device        â”‚
â”‚   - Token format: Hex string                                 â”‚
â”‚     Example: "a1b2c3d4e5f6..."                             â”‚
â”‚                                                              â”‚
â”‚ For Expo Go:                                                 â”‚
â”‚   - Expo service generates token                             â”‚
â”‚   - Token format: ExponentPushToken[...]                     â”‚
â”‚     Example: "ExponentPushToken[abc123...]"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TOKEN RETURNED TO APP                                     â”‚
â”‚    - Expo Notifications API returns token object             â”‚
â”‚    - Format: { data: "token_string", type: "fcm"|"apns" }  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. VALIDATE TOKEN FORMAT                                     â”‚
â”‚    - Check token length (must be > 10 chars)                â”‚
â”‚    - Check token format (native vs Expo)                    â”‚
â”‚    - If invalid, return null                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. SEND TOKEN TO BACKEND                                     â”‚
â”‚    - POST /api/drivers/push-token                           â”‚
â”‚    - Include: driverId, pushToken, tokenType                 â”‚
â”‚    - Retry up to 3 times if it fails                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. BACKEND SAVES TOKEN                                       â”‚
â”‚    - Store in drivers.pushToken column                      â”‚
â”‚    - Use token later to send push notifications             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Code Locations

### 1. Token Request (App Side)
**File**: `DDDriverExpo/src/services/notifications.js`
**Function**: `registerForPushNotifications(driverId)`

**For Standalone Builds** (lines 134-138):
```javascript
const deviceToken = await Notifications.getDevicePushTokenAsync({
  projectId: 'd016afe9-031a-42ca-b832-94c00c800600'
});
```

**For Expo Go** (lines 183-185):
```javascript
const expoToken = await Notifications.getExpoPushTokenAsync({
  projectId: 'd016afe9-031a-42ca-b832-94c00c800600'
});
```

### 2. Token Storage (Backend)
**File**: `backend/routes/drivers.js`
**Endpoint**: `POST /api/drivers/push-token`

Saves the token to the database:
```javascript
driver.pushToken = pushToken;
await driver.save();
```

## Requirements for Token Generation

### For Standalone Builds (Production APK):

1. **google-services.json** must be in project root
   - Contains Firebase project configuration
   - Includes package name, API keys, etc.
   - Downloaded from Firebase Console

2. **FCM Credentials** must be configured in Expo
   - Either via `eas credentials` (FCM Server Key)
   - Or via `google-services.json` (preferred)

3. **Notification Permissions** must be granted
   - User must allow notifications
   - Declared in `app.json` permissions

4. **Build must include FCM SDK**
   - Automatically included when `google-services.json` is present
   - Embedded during `eas build`

### For Expo Go:

1. **Expo Account** must be linked
   - Project ID must be valid
   - Expo service must be accessible

2. **Notification Permissions** must be granted
   - User must allow notifications

## Token Formats

### Native FCM Token (Android Standalone)
- **Format**: Long alphanumeric string
- **Length**: ~150+ characters
- **Example**: `fcm1234567890abcdefghijklmnopqrstuvwxyz...`
- **Generated by**: Google FCM servers
- **Used by**: Firebase Admin SDK on backend

### Native APNs Token (iOS Standalone)
- **Format**: Hex string
- **Length**: ~64 characters
- **Example**: `a1b2c3d4e5f6789012345678901234567890abcdef...`
- **Generated by**: Apple APNs servers
- **Used by**: Firebase Admin SDK on backend

### Expo Push Token (Expo Go)
- **Format**: `ExponentPushToken[...]`
- **Length**: ~50+ characters
- **Example**: `ExponentPushToken[abc123def456...]`
- **Generated by**: Expo Push Notification Service
- **Used by**: Expo Server SDK on backend

## Why Token Generation Can Fail

1. **Missing google-services.json**
   - FCM SDK can't initialize
   - `getDevicePushTokenAsync()` throws error

2. **FCM Credentials Not Configured**
   - No Server Key in Expo
   - No service account in backend

3. **Permissions Not Granted**
   - User denied notification permissions
   - Function returns `null` early

4. **Network Issues**
   - Can't reach FCM/APNs servers
   - Token generation times out

5. **Build Configuration Issues**
   - `google-services.json` not included in build
   - Package name mismatch

## Debugging Token Generation

Check logs for:
- `ğŸ“± Registering for push notifications...` - Function started
- `âœ… Notification permissions granted` - Permissions OK
- `ğŸ“± Is standalone build: true/false` - Build type detected
- `âœ… âœ… âœ… Native device push token obtained` - Token generated
- `âŒ âŒ âŒ CRITICAL ERROR getting native device token` - Token generation failed

## Summary

**The token is NOT generated by our code.** It's generated by:
- **FCM** (for Android standalone builds)
- **APNs** (for iOS standalone builds)  
- **Expo** (for Expo Go)

Our code only:
1. Requests the token from these services
2. Validates the token format
3. Sends it to our backend for storage

The actual token generation happens on Google/Apple/Expo servers when the device contacts them.


